name: docs-only auto-approve & auto-merge
on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
permissions:
  contents: write
  pull-requests: write
jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target (base) branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
      - name: List changed files (server-side)
        id: diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git fetch origin $HEAD_SHA --depth=1
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" | sort > changed.txt
          cat changed.txt
          if grep -vE '^docs/' changed.txt >/dev/null; then
            echo "docs_only=false" >> $GITHUB_OUTPUT
          else
            echo "docs_only=true" >> $GITHUB_OUTPUT
          fi
      - name: Stop if not docs-only
        if: steps.diff.outputs.docs_only != 'true'
        run: |
          echo "Not docs-only, skipping."
          exit 0
      - name: Approve as Code Owner (bot)
        if: steps.diff.outputs.docs_only == 'true'
        uses: juliangruber/approve-pull-request-action@v2.0.3
        with:
          github-token: ${{ secrets.DOCS_BOT_TOKEN }}
          number: ${{ github.event.pull_request.number }}
      - name: Enable auto-merge (squash)
        if: steps.diff.outputs.docs_only == 'true'
        env:
          GH_TOKEN: ${{ secrets.DOCS_BOT_TOKEN }}
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --auto

